#!/bin/bash
# protect-crontab.sh ‚Äî disables "crontab -r" for safety, while keeping -e and -l usable.

CRON_ORIG="/usr/bin/crontab"
CRON_REAL="/usr/bin/crontab.real"

# Make sure we're running as root
if [[ $EUID -ne 0 ]]; then
    echo "‚ùå Please run this script as root."
    exit 1
fi

# Check if already protected
if [[ -f "$CRON_REAL" ]]; then
    echo "‚úÖ Crontab is already protected (wrapper installed at $CRON_ORIG)."
    exit 0
fi

# Move the original binary
echo "üîß Moving original crontab to $CRON_REAL ..."
mv "$CRON_ORIG" "$CRON_REAL"

# Create the wrapper script
echo "üõ°Ô∏è  Creating safe wrapper at $CRON_ORIG ..."
cat <<'EOF' > "$CRON_ORIG"
#!/bin/bash
# Safe wrapper to prevent accidental 'crontab -r' deletion

for arg in "$@"; do
    if [[ "$arg" == "-r" ]]; then
        echo "‚ùå The command 'crontab -r' is disabled on this system for safety."
        echo "If you really need to clear your cron jobs, use 'crontab -e' and remove them manually."
        logger -p auth.warning "Blocked crontab -r attempt by user: $(whoami)"
        exit 1
    fi
done

# Pass all other arguments to the real crontab binary
exec /usr/bin/crontab.real "$@"
EOF

# Make it executable
chmod +x "$CRON_ORIG"

echo "‚úÖ Protection complete! 'crontab -r' is now disabled system-wide."
echo "üß© You can still use 'crontab -e' and 'crontab -l' normally."
